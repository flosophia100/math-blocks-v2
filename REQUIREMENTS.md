# MathBlocks 要件定義書

## 文書情報
- **プロジェクト名**: MathBlocks（計算ブロック）
- **作成日**: 2025-01-11
- **バージョン**: 1.3.0
- **最終更新**: 2025-01-22

## プロジェクト概要

### システム概要
テトリスのような落ちものパズルゲームと四則演算の計算問題を組み合わせた教育的ゲーム。ブロックに表示された計算式を解いて正解するとブロックが消える。暗算力向上を目的とし、小学生から大人まで幅広い年齢層を対象とする。

### 技術基盤
- **開発言語**: HTML5, CSS3, JavaScript ES6+
- **主要API**: Canvas 2D API
- **対応ブラウザ**: Chrome 60+, Firefox 60+, Safari 12+, Edge 80+
- **外部ライブラリ**: なし（スタンドアロン）

### 目標
- 暗算力の向上
- 計算速度の向上
- ゲーム感覚で楽しく学習
- 難易度調整により幅広い年齢層に対応

## 機能要件

### 1. ゲームモード
- **スコアアタックモード**: スコアを競うメインモード
- **タイムアタックモード**: 指定問題数をどれだけ早く解けるか競うモード

### 2. 難易度設定
- **入門（Very Easy）**: 落下速度1500ms、最大2ブロック同時出現
- **イージー**: 落下速度1200ms、最大3ブロック同時出現
- **ノーマル**: 落下速度900ms、最大4ブロック同時出現、ペナルティブロック有効
- **ハード**: 落下速度700ms、最大5ブロック同時出現、ペナルティブロック多発
- **エクストリーム**: 落下速度500ms、最大7ブロック同時出現、高頻度ペナルティ

### 3. 計算式設定
- **四則演算選択**: デバッグパネルで演算を選択可能
  - 足し算（＋）：青緑色で表示
  - 引き算（－）：赤色で表示
  - 掛け算（×）：黄色で表示
  - 割り算（÷）：紫色で表示（割り切れる問題のみ）
- **特訓モード**: 3つの専用練習モード
  - **九九モード**: 1-9の範囲での掛け算練習
  - **おみやげ算**: 10-19の範囲での掛け算練習
  - **さくらんぼ算**: 繰り上がり・繰り下がりの計算練習
- **数値範囲設定**: デバッグパネルで最小値・最大値設定（1〜999の範囲）
- **レベル上昇による難易度調整**: レベルが上がると数値範囲が徐々に拡大

### 4. ゲームプレイ
- **グリッドサイズ**: 横7列 × 縦10行（拡張実装）
- **ブロック**: 1×1サイズの正方形ブロック（視認性向上のため1.5倍サイズ）
- **計算式表示**: 各ブロックに「数字 演算子 数字」形式で表示
- **入力方法**: 画面右側のテンキーまたはキーボード入力
- **正解処理**: 
  - ブロックが即座に破壊され、爆発エフェクト表示
  - 答えを500ms間表示（学習効果向上）
  - 重力システムにより上のブロックが自動落下
- **不正解処理**: 
  - ×印表示とスコア10%減点
  - ノーマル以上でペナルティブロック追加
  - ブロックは落下を続ける

### 5. スコアシステム
- **基本スコア**: 正解ごとに10点
- **連続正解ボーナス**: 
  - 2連続: ×1.2倍
  - 3連続: ×1.5倍
  - 5連続: ×2倍
  - 10連続以上: ×3倍
- **速度ボーナス**: 落下中の早い段階で正解するほど高得点
- **レベルボーナス**: 高レベルほど基本スコアが上昇

### 6. 特殊効果・特殊ブロック
- **特殊ブロック（5%確率）**: 
  - 金色の光る枠線で識別
  - 破壊時に周囲8方向のブロックも連鎖破壊
  - 通常100点 + 連鎖200点のボーナス
- **タイムストップブロック（5%確率）**:
  - 紫色・時計アイコン・点滅枠線で識別
  - 破壊時に10秒間ブロック生成・落下停止
- **ペナルティブロック（ノーマル以上）**:
  - 誤答時にランダム列の最下段に×印ブロック追加
  - 既存ブロックを一段押し上げる
- **視覚効果**:
  - 連続正解エフェクト：5コンボ以上で派手な演出
  - 爆発エフェクト：パーティクルシステム
  - レベルアップ通知：画面中央に表示
  - 警告システム：7段目以上でピンク背景
  - コンボ表示：連続正解数を表示

### 7. ユーザー管理・スコア管理システム
- **ユーザーモード**: アカウント作成でデータ永続化
- **ゲストモード**: 記録を残さずプレイ
- **統計追跡**: 
  - プレイ数、総スコア、正答率、平均時間
  - モード・難易度・特訓別の最高記録
  - リアルタイム統計表示（正解数・誤答数・平均時間）
- **アイテムコレクション**: 
  - メダル系（1000-50000点達成）
  - コンボ系（10-50連続正解達成）
  - プレイ系（10・100回プレイ達成）
- **ハイスコア管理**: 
  - 最大100件保持、多様な並び替え
  - CSV・JSON形式でのエクスポート
  - ランキング表示（上位3位ハイライト）

### 8. ゲームオーバー条件
- ブロックが最上段（10行目）まで積み上がった時点で終了

## 技術仕様

### ファイル構成
```
game/math-blocks/
├── index.html          # メインHTML
├── css/
│   └── styles.css     # スタイルシート
├── js/
│   ├── main.js        # エントリーポイント
│   ├── game.js        # ゲームロジック
│   ├── block.js       # ブロッククラス
│   ├── calculator.js  # 計算問題生成・特訓モード
│   ├── config.js      # 設定・定数定義
│   ├── input.js       # 入力処理・テンキー
│   ├── ui.js          # UI管理・エフェクト
│   ├── scoreManager.js # スコア記録・ランキング
│   └── userManager.js # ユーザー管理・統計
├── server.log         # サーバーログ
└── REQUIREMENTS.md    # この文書
```

### クラス設計
1. **Game**: ゲームループ・状態管理・統計追跡の中核クラス
2. **BlockManager**: ブロック生成・落下・重力・破壊処理
3. **Block**: 個別ブロック（通常・特殊・ペナルティ・タイムストップ）
4. **Calculator**: 計算問題生成・特訓モード・おみやげ算対応
5. **UIManager**: 画面遷移・エフェクト・ユーザー操作処理
6. **ScoreManager**: スコア記録・ランキング・CSV出力
7. **UserManager**: アカウント・統計・アイテム管理
8. **InputManager**: テンキー・キーボード入力処理

### 設定パラメータ
```javascript
const CONFIG = {
    GRID: {
        COLS: 7,           // 横7列（5列から拡張）
        ROWS: 10,
        CELL_SIZE: 90      // 視認性向上のため1.5倍
    },
    DIFFICULTY: {
        veryeasy: { initialSpeed: 1500, speedIncrease: 0.98, maxBlocks: 2 },
        easy:     { initialSpeed: 1200, speedIncrease: 0.96, maxBlocks: 3 },
        normal:   { initialSpeed: 900,  speedIncrease: 0.93, maxBlocks: 4 },
        hard:     { initialSpeed: 700,  speedIncrease: 0.90, maxBlocks: 5 },
        veryhard: { initialSpeed: 500,  speedIncrease: 0.87, maxBlocks: 7 }
    },
    SCORE: {
        BASE: 10,
        COMBO_MULTIPLIERS: {
            2: 1.2,
            3: 1.5,
            5: 2.0,
            10: 3.0
        },
        SPECIAL_BONUS: 100,    // 特殊ブロックボーナス
        CHAIN_BONUS: 200       // 連鎖ボーナス
    },
    SPECIAL_BLOCKS: {
        SPECIAL_RATE: 0.05,    // 特殊ブロック確率5%
        TIMESTOP_RATE: 0.05,   // タイムストップ確率5%
        TIMESTOP_DURATION: 10000 // 10秒間停止
    }
};
```

## UI/UX仕様

### 画面構成
**メイン画面（2000px縦画面対応）**:
```
+----------------------------------+
|           タイトル               |
|        ゲーム設定情報            |
+------------------------+----------+
|                        |  統計    |
|     ゲーム画面         |  情報    |
|    (7列×10行)         |  表示    |
|                        |----------|
|                        |  スコア  |
|                        | 12,345   |
|                        |----------|
|                        |  レベル  |
|                        |    5     |
|                        |----------|
|                        | テンキー |
|                        | [7][8][9]|
|                        | [4][5][6]|
|                        | [1][2][3]|
|                        | [C][0][OK]|
+------------------------+----------+
```

**複数画面遷移**:
1. **ユーザー選択画面**: ゲスト・ユーザーログイン
2. **ゲーム設定画面**: モード・難易度・特訓選択
3. **プレイ画面**: メインゲーム
4. **結果画面**: スコア・統計・アイテム獲得
5. **ハイスコア画面**: ランキング・エクスポート

### 操作方法
- **テンキー**: マウスクリック・タッチ・キーボード数字キー対応
- **Cボタン**: 入力をクリア（5回連続でデバッグパネル）
- **OKボタン/Enterキー**: 答えを確定
- **ESCキー**: ゲーム一時停止
- **隠し機能**:
  - タイトル画面：スコアアタックボタン5回連続クリック → デバッグパネル
  - ゲーム画面：Cボタン5回連続クリック → デバッグパネル

### ビジュアル要件
- **デザイン**: シンプルでクリーンなフラットデザイン
- **配色**: 
  - 背景: 薄いグレー (#f0f0f0)
  - 演算別ブロック: 足し算（青緑）・引き算（赤）・掛け算（黄）・割り算（紫）
  - 特殊ブロック: 金色光る枠線
  - タイムストップ: 紫色・時計アイコン・点滅枠
  - 警告システム: 7段目以上でピンク背景
  - テキスト: ダークグレー (#333333)
- **フォント**: 計算式は大きく読みやすいサンセリフ体
- **アニメーション**: 
  - 爆発エフェクト：パーティクルシステム
  - 連鎖爆発：周囲8方向破壊演出
  - 正解表示：答えを500ms間強調
  - 重力落下：滑らかな200px/秒アニメーション
  - コンボ演出：5コンボ以上で派手な視覚効果

### 効果音
- **基本方針**: 音響効果なし（静音学習環境対応）
- **将来検討**: プロシージャル効果音の実装可能性

## 開発ガイドライン

### コーディング規約
- モジュール化されたES6クラス構文を使用
- 関数は単一責任の原則に従う
- コメントは日本語で記述
- 定数は大文字のスネークケース

### パフォーマンス基準
- 60FPSでの安定動作（Canvas 2D API最適化）
- オブジェクトプール使用によるメモリ効率化
- LocalStorageによるデータ永続化（最大100件スコア保持）
- 不要なDOM操作の最小化

### テスト要件
- 各演算子での計算検証（特訓モード含む）
- 境界値テスト（最小値・最大値・おみやげ算）
- ゲームオーバー条件・重力システムテスト
- スコア計算・コンボ・特殊ブロック効果の正確性
- ユーザー管理・統計データの整合性
- ペナルティブロック・タイムストップ機能検証

## 拡張計画

### Phase 2（現在の実装で一部達成済み）
- ✅ ランキング機能（ハイスコア画面実装）
- ✅ 実績システム（アイテムコレクション）
- ✅ 詳細な統計情報（ユーザー管理システム）
- 🔄 マルチプレイヤーモード（未実装）

### Phase 3
- 🔄 モバイル対応（レスポンシブ対応済み、タッチ最適化可能）
- 🔄 PWA化（オフライン対応）
- 🔄 音声入力対応
- 🔄 教育機関向け管理機能
- 🔄 AI難易度自動調整
- 🔄 プロシージャル効果音システム

## 現在の実装状況総括

**MathBlocks v1.3.0** は当初の要件を大幅に上回る機能を実装した**商用レベルの教育ゲームアプリケーション**として完成しています。

### 主要達成項目
- **7×10拡張グリッド**: より戦略的なゲームプレイ
- **5段階難易度システム**: 幅広いスキルレベルに対応
- **3つの特訓モード**: 体系的な計算練習システム
- **包括的ユーザー管理**: アカウント・統計・アイテム管理
- **高品質エフェクト**: パーティクル・重力・連鎖システム
- **デバッグシステム**: 隠し機能による詳細設定

### 教育的価値
- 暗算力向上: 段階的難易度調整
- 計算速度向上: タイムプレッシャーとボーナス
- 学習継続性: 統計追跡とアイテム収集
- 個別最適化: ユーザー別進捗管理

### 技術的完成度
- 60FPS安定動作
- モジュール化設計
- エラーハンドリング
- データ永続化（LocalStorage）
- レスポンシブ対応

**結論**: 現在の実装は教育機関での実用に耐える**完成された学習ゲーム**として評価できます。

## 更新履歴

### 2025-01-13: 安定版リリース - 完全機能実装版
- **ゲーム機能拡張**:
  - 7×10グリッド対応・最大7ブロック同時出現
  - 5段階難易度システム（入門・イージー・ノーマル・ハード・エクストリーム）
  - 3つの特訓モード（九九・おみやげ算・さくらんぼ算）
  - ハイスコア強調表示・60秒タイムアタック
  - リアルタイム統計表示（正解数・誤答数・平均時間）

- **UI/UX大幅改善**:
  - 正解時の答え表示エフェクト（500ms間答えを表示）
  - ゲーム画面にタイトル・設定情報・統計情報表示
  - グリッドレイアウト最適化（2000px縦画面対応）
  - テンキーレイアウト改善（0・OK大型化、C最小化）
  - 一時停止・終了ボタン小型化

- **隠し機能・デバッグシステム**:
  - タイトル画面: スコアアタック5回クリック → デバッグパネル
  - ゲーム画面: C5回クリック → デバッグパネル
  - レベルアップ時同時出現数減少防止機能

- **技術改善**:
  - 特殊ブロック確率5%・枠線のみ点滅
  - ブロック管理システム最適化
  - スコア記録システム拡張（統計データ保存）
  - パフォーマンス最適化

### 2025-01-13: 計算設定の隠し機能化・UI改善
- **計算設定をデバッグパネルに移動**: タイトル画面から計算設定を削除し、デバッグパネルに統合
- **隠し機能実装**: 
  - タイトル画面: スコアアタックボタンを5回連続クリックでデバッグパネル起動
  - ゲーム画面: Cボタンを5回連続クリックでデバッグパネル起動
- **UI改善**: 「スコア確認」を「ハイスコア」に名称変更
- **デバッグボタン削除**: ゲーム画面からデバッグボタンを削除し、隠し機能に統合

### 2025-01-11 17:45: UI改善・爆発エフェクト修正版（安定バージョン）
- **スコア画面アクセス改善**: ゲーム画面から削除してタイトル画面に移動
- **スコア記録簡素化**: 日時表示を月日のみに変更（M/D形式）
- **爆発エフェクト修正**: 落下中ブロック破壊時のパーティクル描画問題解決
- **UI/UX改善**: ゲーム画面をすっきりさせ、プレイに集中しやすく改善
- **ゲームオーバー画面**: スコア確認ボタンを追加
- **全体安定性**: 全機能の動作確認完了、安定バージョンとして確定

### 2025-01-11 17:30: スコアボード画面完全実装
- **完全スコア記録システム**: localStorage使用で最大100件保存
- **多形式エクスポート**: HTML、JSON、CSV形式での出力機能
- **ランキング表示**: 上位3位のハイライト（ゴールド/シルバー/ブロンズ）
- **詳細記録**: スコア、コンボ、レベル、ゲーム条件を包括的に記録
- **視覚的改善**: 見やすいテーブルデザインと操作ボタン

### 2025-01-11 17:15: アニメーション・エフェクト・スコアシステム改善
- **爆発エフェクト大幅改良**: パーティクルシステムで視覚的インパクト向上
- **特殊ブロック実装**: 10%確率で点滅ブロック、連鎖爆発機能
- **不正解フィードバック**: ×印表示とスコア減点システム
- **コンボアニメーション**: 5コンボ以上で派手なエフェクト
- **スコア減点システム**: 間違い時に現在スコアの10%減点

### 2025-01-11 17:00: UI・警告システム・ブロック制御改善
- **ブロック・マス目1.5倍化**: 視認性向上のためサイズアップ
- **警告システム**: 7段目以上でピンク背景表示
- **複数ブロック制御**: 必ず違う列から落下、最大4個同時
- **ゲームバランス調整**: より戦略的なプレイが可能

### 2025-01-11 16:45: ブロック重力落下機能追加
- **重力システム**: 下のブロック破壊時に上のブロックが自動落下
- **滑らかアニメーション**: 200px/秒の落下速度で視覚的に分かりやすく
- **連鎖対応**: 複数列同時の重力処理に対応

### 2025-01-11 16:30: MathBlocks機能改善完了
- **正解判定拡張**: 落下中・固定済み両方のブロックに対応
- **演算色分け**: 四則演算ごとの色分け（+青緑、-赤、×黄、÷紫）
- **デバッグパネル**: リアルタイム設定変更機能
- **複数ブロック対応**: 同時に最大4個まで落下可能

### 2025-01-22: 実装状況調査に基づく要件定義書更新
- **文書バージョン更新**: v1.3.0に更新
- **実装済み機能の網羅的反映**: 
  - 7×10拡張グリッド・5段階難易度・特訓モード
  - ユーザー管理・アイテムコレクション・統計システム
  - 特殊ブロック・ペナルティ・タイムストップ機能
  - 重力システム・パーティクル爆発エフェクト
- **技術仕様更新**: ファイル構成・クラス設計・設定パラメータ
- **UI/UX仕様更新**: 複数画面・操作方法・隠し機能
- **品質評価**: 商用レベル完成度の総括
- **拡張計画更新**: 実装済み項目のステータス明記

### 2025-01-11 15:30: 初版作成
- 初版作成
- ユーザー要件に基づく仕様策定